Array.prototype.find||(Array.prototype.find=function(n){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined")
if("function"!=typeof n)throw new TypeError("predicate must be a function")
for(var e,t=Object(this),o=t.length>>>0,r=arguments[1],i=0;o>i;i++)if(e=t[i],n.call(r,e,i,t))return e}),"angular"in window&&!function(){"use strict"
angular.module("xsockets",[]),angular.module("xsockets").provider("xsocketsController",[function(){var n=this,e=JSON.parse(localStorage.getItem("ci")?localStorage.getItem("ci"):"{}"),t=function(n){var e="?"
return delete n.C,Object.keys(n).forEach(function(t){e+=t+"="+encodeURIComponent(n[t])+"&"}),e=e.slice(0,e.length-1)},o=function(e,t){var o=n.listeners.filter(function(n){var t=n.topic
return t instanceof RegExp?n.controller===e.C&&e.T.match(t):n.controller===e.C&&t===e.T})
if(o.forEach(function(n){n.fn.fire(JSON.parse(e.D),t,e.C)}),n.promises.hasOwnProperty(e.T)){var r=JSON.parse(e.D)
n.promises[e.T].resolve({key:r.K,value:r.V})}},r=function(n,e){var t=n,o=function(n){return String.fromCharCode.apply(null,new Uint16Array(n))},r=function(n){for(var e=0,t=n.byteLength-1;t>=0;t--)e=256*e+n[t]
return parseInt(e)},i=new Uint8Array(t,0,8),s=r(i),c=parseInt(8+r(i))
e(o(new Uint8Array(t,8,s)),new Uint8Array(t,parseInt(c),t.byteLength-c),i)}
this.promises={},this.onconnected=function(){this.isConnected=!0},this.ondisconnected=function(){n.reconnect()},this.connectionAttempts=0,this.maxConnectionAttempts=5,this.controllers=[],this.listeners=[],this.queue=[],this.connection=void 0,this.isConnected=!1,this.isReconnecting=!1,this.reconnect=function(){this.connectionAttempts++,this.isReconnecting||(this.isReconnecting=!0,this.open())},this.url="",this.open=function(i,s,c){arguments.length>0&&(c?this.url=i:this.url=i+t(angular.extend({},e,s))),this.connection=new window.WebSocket(this.url,"XSocketsNET"),this.connection.binaryType="arraybuffer",this.connection.onclose=function(e){n.isReconnecting=!1,n.isConnected=!1,n.ondisconnected&&n.ondisconnected.apply(e)},this.sendReconnectToAllControllers=function(){for(var e=0;e<n.controllers.length;e++)o({T:"onreopened",C:n.controllers[e].controller,D:null})},this.connection.onopen=function(e){n.connectionAttempts=0,n.isReconnecting&&n.sendReconnectToAllControllers(),n.isReconnecting=!1,n.queue.forEach(function(e){n.send(e)}),n.queue.length=0,n.onconnected&&n.onconnected.apply(e)},this.connection.onmessage=function(n){n.data instanceof ArrayBuffer?r(n.data,function(n,e,t){var r=JSON.parse(n)
o(r,new Uint8Array(e),t)}):o(JSON.parse(n.data))}},this.sendBinary=function(n){this.connection.send(n)},this.send=function(n){1===this.connection.readyState?this.connection.send(n.toString()):this.queue.push(n)},this.setState=function(n,e){var t=this.controllers.find(function(e){return e.controller===n})
t&&(t.readyState=e)},this.controllerIsOpen=function(e){return this.controllers.find(function(n){return n.controller===e})?!0:(n.controllers.push({controller:e,readyState:0}),!1)},this.uuid=function(n,e){for(e=n="";n++<36;e+=51*n&52?(15^n?8^Math.random()*(20^n?16:4):4).toString(16):"-");return e},this.listener=function(n,e,t,o){this.instance=n,this.topic=e,this.controller=t,this.fn=o},this.$get=["$q","$rootScope",function(e,t){return function(o,r){var i={init:"1",ping:"7",pong:"8",controller:{onError:"4",onOpen:"2",onClose:"3"},storage:{set:"s1",get:"s2",clear:"s4",remove:"s3"},pubSub:{subscribe:"5",unsubscribe:"6"}},s=function(n){var e=function(n){this.fn=n}
return e.prototype.fire=function(e,t){n.$digest(this.fn.apply(this,[e,t]))},e}(t),c=n.uuid(),u=function(e,t,o){var r=n.listeners.filter(function(n){var r=n.topic===t&&n.controller===o&&n.instance===e
return r})
return r},l=function(e,t){var o=n.listeners.indexOf(u(c,e,t))
n.listeners.splice(o,1)},a=function(e,t,r,i){var l=new n.listener(e,t,r,new s(i)),a=u(c,t,o)
if(0===a.length)n.listeners.push(l)
else{var f=n.listeners.indexOf(a[0])
n.listeners[f]=l}},f=function(e,t){for(var o=0;o<n.listeners.length;o++)n.listeners[o].controller===t&&n.listeners[o].instance===e&&n.listeners.splice(o,1)},h=function(n){for(var e=[0,0,0,0,0,0,0,0],t=0;t<e.length;t++){var o=255&n
e[t]=o,n=(n-o)/256}return e},p=function(){var n=function(n,e,t){this.T=n?n.toLowerCase():void 0,this.D=e,this.C=t?t.toLowerCase():void 0,this.JSON={T:n,D:JSON.stringify(e),C:t}}
return n.prototype.toString=function(){return JSON.stringify(this.JSON)},n}(),d=function(){var n=function(n,e,t){this.buffer=this.createBuffer(new p(e,t,o).toString(),n)}
return n.prototype.stringToBuffer=function(n){var e,t=n.length,o=new Array(t)
for(e=0;t>e;e++)o[e]=255&n.charCodeAt(e)
return new Uint8Array(o).buffer},n.prototype.appendBuffer=function(n,e){var t=new Uint8Array(n.byteLength+e.byteLength)
return t.set(new Uint8Array(n),0),t.set(new Uint8Array(e),n.byteLength),t.buffer},n.prototype.createBuffer=function(n,e){var t=new Uint8Array(h(n.length)),o=this.appendBuffer(this.appendBuffer(t,this.stringToBuffer(n)),e)
return o},n}(),g=function(n){var t=e.defer(),o=new FileReader
return o.onload=function(){return function(n){t.resolve(n.target.result)}}(n),o.readAsArrayBuffer(n),t.promise},y=function(e){n.send(e)},v=function(n,e){var t,r="set_"+n.toLowerCase()
t=e instanceof Array?{value:e}:e instanceof Object?e:{value:e},y(new p(r,t,o))},w=function(n,e){var t="set_"+n.toLowerCase()
y(new p(t,e,o))},b=function(e){n.controllerIsOpen(e)||y(new p(i.init,{init:!0},e))},m=function(){y(new p(i.controller.onClose,{},o))},A={controllerName:o,uuid:c,onerror:null,onopen:null,onclose:null,onreopened:null,on:function(n,e){a(c,n,o,e)},off:function(n){l(c,n,o)},invokeBinary:function(e){n.sendBinary(e)},createBlob:function(n,e){return new Blob([n],e)},createBinaryMessage:function(n,e,t){return new d(n,e,t).buffer},invoke:function(n,e){y(new p(n,e,o))},publish:function(n,e){y(new p(n,e,o))},kill:function(){n.connection.close()},getArrayBuffer:g,connectionAttempts:n.connectionAttempts,close:m,subscribe:function(n,e){a(c,n,o,e),y(new p(i.pubSub.subscribe,{T:n},o))},unsubscribe:function(n){l(c,n,o),y(new p(i.pubSub.unsubscribe,{T:n},o))},setEnum:w,storage:{set:function(n,e){n=n.toLowerCase()
var t=new p(i.storage.set,{K:n,V:"object"==typeof e?JSON.stringify(e):e},o)
return y(t),t},get:function(t){t=t.toLowerCase()
var r=e.defer(),s=i.storage.get+":"+t
n.promises[s]=r
var c=new p(i.storage.get,{K:t},o)
return y(c),r.promise},clear:function(){var n=new p(i.storage.clear,{},o)
y(n)},remove:function(n){n=n.toLowerCase()
var e=new p(i.storage.remove,{K:n},o)
y(e)}},setProperty:v,getListeners:function(){return n.listeners.filter(function(n){return n.controller===o&&n.instance===c})},removeListeners:f}
return a(c,i.controller.onOpen,o,function(n){var e={persistentId:n.PI,connectionId:n.CI}
localStorage.setItem("ci",JSON.stringify(e)),A.onopen&&A.onopen(e)}),a(c,i.controller.onClose,o,function(n){A.onclose&&A.onclose()}),a(c,i.controller.onError,o,function(n){A.onerror&&A.onerror(n,o)}),a(c,"onreopened",o,function(n){A.onreopened&&A.onreopened(n,o)}),arguments[1]instanceof Array?r.forEach(function(n){v(n.name,n.value)}):2===arguments.length&&arguments[1].$on("$destroy",function(){A.close()}),3===arguments.length&&arguments[2].$on("$destroy",function(){A.close()}),b(o),A}}]}])}()
