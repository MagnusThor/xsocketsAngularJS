angular.module("xsockets",[]);angular.module("xsockets").provider("xsocketsController",[function(){var i=function(n){var i="?";return delete n.C,Object.keys(n).forEach(function(n){i+=n+"="+encodeURIComponent(t[n])+"&"}),i=i.slice(0,i.length-1)},t=JSON.parse(localStorage.getItem("ci")?localStorage.getItem("ci"):"{}"),n=this;this.connection=undefined;this.isConnected=!1;this.open=function(n){this.connection=new window.WebSocket(n+i(t));this.connection.binaryType="arraybuffer"};this.deferred={};this.listeners=[];this.$get=["$q","$rootScope","$timeout",function(t,i,r){return function(u,f){var v=this,h,o,a;n.deferred[u]=new t.defer;h={init:"1",ping:"7",pong:"8",controller:{onError:"4",onOpen:"2",onClose:"3"},storage:{set:"s1",get:"s2",clear:"s4",remove:"s3"},pubSub:{subscribe:"5",unsubscribe:"6"}};this.queue=[];var e=n.listeners,c=function(n,t){return e.filter(function(i){return i.topic===n&&i.controller===t})},y=function(n,t){var i=e.indexOf(c(n,t));e.splice(i,1)},l=function(n,t,i){e.push({topic:n,controller:t,fn:i})},p=function(n){for(var r,t=[0,0,0,0,0,0,0,0],i=0;i<t.length;i++)r=n&255,t[i]=r,n=(n-r)/256;return t},s=function(){var n=function(n,t,i){this.T=n?n.toLowerCase():undefined;this.D=t;this.C=i?i.toLowerCase():undefined;this.JSON={T:n,D:JSON.stringify(t),C:i}};return n.prototype.toString=function(){return JSON.stringify(this.JSON)},n}(),w=function(){var n=function(n,t,i){this.buffer=this.createBuffer(new s(t,i,u).toString(),n)};return n.prototype.stringToBuffer=function(n){for(var i=n.length,r=new Array(i),t=0;t<i;t++)r[t]=n.charCodeAt(t)&255;return new Uint8Array(r).buffer},n.prototype.appendBuffer=function(n,t){var i=new Uint8Array(n.byteLength+t.byteLength);return i.set(new Uint8Array(n),0),i.set(new Uint8Array(t),n.byteLength),i.buffer},n.prototype.createBuffer=function(n,t){var i=new Uint8Array(p(n.length));return this.appendBuffer(this.appendBuffer(i,this.stringToBuffer(n)),t)},n}(),b=function(n,t){var i=n,e=function(n){return String.fromCharCode.apply(null,new Uint16Array(n))},u=function(n){for(var t=0,i=n.byteLength-1;i>=0;i--)t=t*256+n[i];return parseInt(t)},r=new Uint8Array(i,0,8),o=u(r),f=parseInt(8+u(r));return t(e(new Uint8Array(i,8,o)),new Uint8Array(i,parseInt(f),i.byteLength-f),r),this};return n.connection.onmessage=function(n){var r,t;typeof n.data=="string"?(t=JSON.parse(n.data),r=c(t.T,t.C,e),r&&r.forEach(function(n){i.$apply(n.fn.apply(this,[JSON.parse(t.D),t.C]))})):b(n.data,function(n,u){t=JSON.parse(n);r=c(t.T,t.C,e);r&&r.forEach(function(n){i.$apply(n.fn.apply(this,[JSON.parse(t.D),u,t.C]))})})},o=function(t){n.connection.readyState===0?v.queue.push(t):n.connection.send(t)},a={on:function(n,t){var r=c(n,u),i;r.length===0?l(n,u,t):(i=e.indexOf(c(n,u)[0]),e[i]={topic:n,controller:u,fn:t})},off:function(n){y(n,u)},invokeBinary:function(n){o(n)},createBinaryMessage:function(n,t,i){return new w(n,t,i)},invoke:function(n,t){o(new s(n,t,u))},publish:function(n,t){o(new s(n,t,u))},close:function(){e.filter(function(n){n.controller=u}).forEach(function(n){e.splice(n,1)});o(new s(h.controller.onClose,{},u))},subscribe:function(n){l(n,u);o(new s(h.pubSub.subscribe,{T:n},u))},unsubscribe:function(n){y(n,u);o(new s(h.pubSub.unsubscribe,{T:n},u))},setEnum:function(n,t){var i="set_"+n.toLowerCase();o(new s(i,t,u))},setProperty:function(n,t){var i,r="set_"+n.toLowerCase();i=t instanceof Array?{value:t}:t instanceof Object?t:{value:t};o(new s(r,i,u))},getListeners:function(){return e.filter(function(n){return n.controller===u})}},l(h.controller.onOpen,u,function(t){var i={persistentId:t.PI,connectionId:t.CI};localStorage.setItem("ci",JSON.stringify(i));n.deferred[u].resolve(a,i)}),l(h.controller.onClose,u,function(){a.close()}),l(h.controller.onError,u,function(t){n.deferred[u].reject(t)}),o(new s(h.init,{init:!0},u).toString()),r(function(){v.queue.forEach(function(t){n.connection.send(t)});v.queue=[]},1e3),f&&f.$on("$destroy",function(){a.close()}),n.deferred[u].promise}}]}]);