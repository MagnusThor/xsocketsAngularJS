angular.module("xsockets",[]);angular.module("xsockets").provider("xsocketsController",[function(){var i=function(n){var i="?";return delete n.C,Object.keys(n).forEach(function(n){i+=n+"="+encodeURIComponent(t[n])+"&"}),i=i.slice(0,i.length-1)},t=JSON.parse(localStorage.getItem("ci")?localStorage.getItem("ci"):"{}"),n=this;this.connection=undefined;this.isConnected=!1;this.open=function(n){this.connection=new window.WebSocket(n+i(t))};this.deferred={};this.listeners=[];this.$get=["$q","$rootScope",function(t,i){return function(r,u){var v=this;n.deferred[r]=new t.defer;this.queue=[];var f=n.listeners,c=function(n,t){var i=f.filter(function(i){return i.topic===n&&i.controller===t});return console.log("found a listener for %s and % %s",n,t),i},l=function(n,t){var i=f.indexOf(c(n,t));f.splice(i,1)},h=function(n,t,i){f.push({topic:n,controller:t,fn:i})};n.connection.onmessage=function(n){var t=JSON.parse(n.data),r=c(t.T,t.C,f);r&&r.forEach(function(n){console.log("listener fn.apply for %s and %s",t.T,t.C);i.$apply(n.fn.apply(this,[t.D,t.C]))})};var s={init:"1",ping:"7",pong:"8",controller:{onError:"4",onOpen:"2",onClose:"3"},storage:{set:"s1",get:"s2",clear:"s4",remove:"s3"},pubSub:{subscribe:"5",unsubscribe:"6"}},e=function(){var n=function(n,t,i){this.T=n?n.toLowerCase():undefined;this.D=t;this.C=i?i.toLowerCase():undefined;this.JSON={T:n,D:JSON.stringify(t),C:i}};return n.prototype.toString=function(){return JSON.stringify(this.JSON)},n}(),o=function(t){n.connection.readyState===0?v.queue.push(t):n.connection.send(t)},a={on:function(n,t){var u=c(n,r),i;u.length===0?h(n,r,t):(i=f.indexOf(c(n,r)[0]),f[i]={topic:n,controller:r,fn:t})},off:function(n){l(n,r)},invoke:function(n,t){o(new e(n,t,r))},publish:function(n,t){o(new e(n,t,r))},close:function(){f.filter(function(n){n.controller=r}).forEach(function(n){f.splice(n,1)});o(new e(s.controller.onClose,{},r))},subscribe:function(n){h(n,r);o(new e(s.pubSub.subscribe,{T:n},r))},unsubscribe:function(n){l(n,r);o(new e(s.pubSub.unsubscribe,{T:n},r))},setEnum:function(n,t){var i="set_"+n.toLowerCase();o(new e(i,t,r))},setProperty:function(n,t){var u="set_"+n.toLowerCase(),i;i=t instanceof Array?{value:t}:t instanceof Object?t:{value:t};o(new e(u,i,r))},getListeners:function(){return f.filter(function(n){return n.controller===r})}};return h(s.controller.onOpen,r,function(t){t=JSON.parse(t);var i={persistentId:t.PI,connectionId:t.CI};localStorage.setItem("ci",JSON.stringify(i));n.deferred[r].resolve(a,i)}),h(s.controller.onClose,r,function(){console.log("not yet implemented")}),h(s.controller.onError,r,function(t){n.deferred[r].reject(t)}),o(new e(s.init,{init:!0},r).toString()),u&&u.$on("$destroy",function(){a.close()}),n.deferred[r].promise}}]}]);