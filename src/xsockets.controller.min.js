(function(){"use strict";angular.module("xsockets",[]);angular.module("xsockets").provider("xsocketsController",[function(){var n=this,t=this,r=JSON.parse(localStorage.getItem("ci")?localStorage.getItem("ci"):"{}"),i;this.deferred={};this.listeners=[];this.queue=[];this.connection=undefined;this.isConnected=!1;this.createUrl=function(){throw"Not implemented";};i=function(n){var t="?";return delete n.C,Object.keys(n).forEach(function(i){t+=i+"="+encodeURIComponent(n[i])+"&"}),t=t.slice(0,t.length-1)};this.open=function(n,u){this.connection=new window.WebSocket(n+i(angular.extend({},r,u)));this.connection.binaryType="arraybuffer";this.connection.onopen=function(){t.queue.forEach(function(n){t.send(n)});t.queue.length=0}};this.connect=open;this.send=function(n){this.connection.readyState===1?this.connection.send(n.toString()):this.queue.push(n)};this.$get=["$q","$rootScope",function(t,i){return function(r,u){n.deferred[r]=new t.defer;n.connection.onmessage=function(n){var r,t;typeof n.data=="string"?(t=JSON.parse(n.data),r=s(t.T,t.C),r&&r.forEach(function(n){i.$apply(n.fn.apply(this,[JSON.parse(t.D),t.C]))})):w(n.data,function(n,u){t=JSON.parse(n);r=s(t.T,t.C);r&&r.forEach(function(n){i.$apply(n.fn.apply(this,[JSON.parse(t.D),u,t.C]))})})};var o={init:"1",ping:"7",pong:"8",controller:{onError:"4",onOpen:"2",onClose:"3"},storage:{set:"s1",get:"s2",clear:"s4",remove:"s3"},pubSub:{subscribe:"5",unsubscribe:"6"}},s=function(t,i){return n.listeners.filter(function(n){return n.topic===t&&n.controller===i})},l=function(t,i){var r=n.listeners.indexOf(s(t,i));n.listeners.splice(r,1)},h=function(t,i,r){n.listeners.push({topic:t,controller:i,fn:r})},v=function(t){for(var i=0;i<n.listeners.length;i++)n.listeners[i].controller===t&&n.listeners.splice(i,1)},y=function(n){for(var r,t=[0,0,0,0,0,0,0,0],i=0;i<t.length;i++)r=n&255,t[i]=r,n=(n-r)/256;return t},f=function(){var n=function(n,t,i){this.T=n?n.toLowerCase():undefined;this.D=t;this.C=i?i.toLowerCase():undefined;this.JSON={T:n,D:JSON.stringify(t),C:i}};return n.prototype.toString=function(){return JSON.stringify(this.JSON)},n}(),p=function(){var n=function(n,t,i){this.buffer=this.createBuffer(new f(t,i,r).toString(),n)};return n.prototype.stringToBuffer=function(n){for(var i=n.length,r=new Array(i),t=0;t<i;t++)r[t]=n.charCodeAt(t)&255;return new Uint8Array(r).buffer},n.prototype.appendBuffer=function(n,t){var i=new Uint8Array(n.byteLength+t.byteLength);return i.set(new Uint8Array(n),0),i.set(new Uint8Array(t),n.byteLength),i.buffer},n.prototype.createBuffer=function(n,t){var i=new Uint8Array(y(n.length));return this.appendBuffer(this.appendBuffer(i,this.stringToBuffer(n)),t)},n}(),w=function(n,t){var i=n,e=function(n){return String.fromCharCode.apply(null,new Uint16Array(n))},u=function(n){for(var t=0,i=n.byteLength-1;i>=0;i--)t=t*256+n[i];return parseInt(t)},r=new Uint8Array(i,0,8),o=u(r),f=parseInt(8+u(r));return t(e(new Uint8Array(i,8,o)),new Uint8Array(i,parseInt(f),i.byteLength-f),r),this},e=function(t){n.send(t)},a=function(n,t){var i,u="set_"+n.toLowerCase();i=t instanceof Array?{value:t}:t instanceof Object?t:{value:t};e(new f(u,i,r))},b=function(n){e(new f(o.init,{init:!0},n))},k=function(){e(new f(o.controller.onClose,{},r))},c={onerror:null,on:function(t,i){var f=s(t,r),u;f.length===0?h(t,r,i):(u=n.listeners.indexOf(s(t,r)[0]),n.listeners[u]={topic:t,controller:r,fn:i})},off:function(n){l(n,r)},invokeBinary:function(n){e(n)},createBinaryMessage:function(n,t,i){return new p(n,t,i)},invoke:function(n,t){e(new f(n,t,r))},publish:function(n,t){e(new f(n,t,r))},close:k,subscribe:function(n,t){h(n,r,t);e(new f(o.pubSub.subscribe,{T:n},r))},unsubscribe:function(n){l(n,r);e(new f(o.pubSub.unsubscribe,{T:n},r))},setEnum:function(n,t){var i="set_"+n.toLowerCase();e(new f(i,t,r))},storage:{set:function(){throw"Not implemented";},get:function(){throw"Not implemented";},clear:function(){throw"Not implemented";},remove:function(){throw"Not implemented";}},setProperty:a,getListeners:function(){return n.listeners.filter(function(n){return n.controller===r})}};return h(o.controller.onOpen,r,function(t){var i={persistentId:t.PI,connectionId:t.CI};localStorage.setItem("ci",JSON.stringify(i));n.deferred[r].resolve(c,i)}),h(o.controller.onClose,r,function(n){v(n.C)}),h(o.controller.onError,r,function(t){if(c.onerror)c.onerror(t,r);n.deferred[r].reject(t)}),arguments[1]instanceof Array?u.forEach(function(n){a(n.name,n.value)}):arguments.length===2&&arguments[1].$on("$destroy",function(){c.close()}),arguments.length===3&&arguments[2].$on("$destroy",function(){c.close()}),b(r),n.deferred[r].promise}}]}])})();