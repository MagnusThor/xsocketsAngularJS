angular.module("xsockets",[]);angular.module("xsockets").provider("xsocketsController",[function(){var i=function(n){var i="?";return delete n.C,Object.keys(n).forEach(function(n){i+=n+"="+encodeURIComponent(t[n])+"&"}),i=i.slice(0,i.length-1)},t=JSON.parse(localStorage.getItem("ci")?localStorage.getItem("ci"):"{}"),n=this;this.connection=undefined;this.isConnected=!1;this.open=function(n){this.connection=new window.WebSocket(n+i(t))};this.deferred={};this.listeners=[];this.$get=["$q","$rootScope","$timeout",function(t,i,r){return function(u,f){var a=this;n.deferred[u]=new t.defer;this.queue=[];var e=n.listeners,l=function(n,t){return e.filter(function(i){return i.topic===n&&i.controller===t})},v=function(n,t){var i=e.indexOf(l(n,t));e.splice(i,1)},c=function(n,t,i){e.push({topic:n,controller:t,fn:i})};n.connection.onmessage=function(n){var t=JSON.parse(n.data),r=l(t.T,t.C,e);r&&r.forEach(function(n){i.$apply(n.fn.apply(this,[JSON.parse(t.D),t.C]))})};var h={init:"1",ping:"7",pong:"8",controller:{onError:"4",onOpen:"2",onClose:"3"},storage:{set:"s1",get:"s2",clear:"s4",remove:"s3"},pubSub:{subscribe:"5",unsubscribe:"6"}},o=function(){var n=function(n,t,i){this.T=n?n.toLowerCase():undefined;this.D=t;this.C=i?i.toLowerCase():undefined;this.JSON={T:n,D:JSON.stringify(t),C:i}};return n.prototype.toString=function(){return JSON.stringify(this.JSON)},n}(),s=function(t){n.connection.readyState===0?a.queue.push(t):n.connection.send(t)},y={on:function(n,t){var r=l(n,u),i;r.length===0?c(n,u,t):(i=e.indexOf(l(n,u)[0]),e[i]={topic:n,controller:u,fn:t})},off:function(n){v(n,u)},invoke:function(n,t){s(new o(n,t,u))},publish:function(n,t){s(new o(n,t,u))},close:function(){e.filter(function(n){n.controller=u}).forEach(function(n){e.splice(n,1)});s(new o(h.controller.onClose,{},u))},subscribe:function(n){c(n,u);s(new o(h.pubSub.subscribe,{T:n},u))},unsubscribe:function(n){v(n,u);s(new o(h.pubSub.unsubscribe,{T:n},u))},setEnum:function(n,t){var i="set_"+n.toLowerCase();s(new o(i,t,u))},setProperty:function(n,t){var r="set_"+n.toLowerCase(),i;i=t instanceof Array?{value:t}:t instanceof Object?t:{value:t};s(new o(r,i,u))},getListeners:function(){return e.filter(function(n){return n.controller===u})}};return c(h.controller.onOpen,u,function(t){var i={persistentId:t.PI,connectionId:t.CI};localStorage.setItem("ci",JSON.stringify(i));n.deferred[u].resolve(y,i)}),c(h.controller.onClose,u,function(){console.log("not yet implemented")}),c(h.controller.onError,u,function(t){n.deferred[u].reject(t)}),s(new o(h.init,{init:!0},u).toString()),r(function(){a.queue.forEach(function(t){n.connection.send(t)});a.queue=[]},1e3),f&&f.$on("$destroy",function(){y.close()}),n.deferred[u].promise}}]}]);