Array.prototype.find||(Array.prototype.find=function(n){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined")
if("function"!=typeof n)throw new TypeError("predicate must be a function")
for(var e,t=Object(this),r=t.length>>>0,o=arguments[1],i=0;r>i;i++)if(e=t[i],n.call(o,e,i,t))return e}),"angular"in window&&!function(){"use strict"
angular.module("xsockets",[]),angular.module("xsockets").provider("xsocketsController",[function(){var n=this,e=JSON.parse(localStorage.getItem("ci")?localStorage.getItem("ci"):"{}"),t=function(n){var e="?"
return delete n.C,Object.keys(n).forEach(function(t){e+=t+"="+encodeURIComponent(n[t])+"&"}),e=e.slice(0,e.length-1)},r=function(e,t){var r=n.listeners.filter(function(n){var t=n.topic
return t instanceof RegExp?n.controller===e.C&&e.T.match(t):n.controller===e.C&&t===e.T})
if(r.forEach(function(n){n.fn.fire(JSON.parse(e.D),t,e.C)}),n.promises.hasOwnProperty(e.T)){var o=JSON.parse(e.D)
n.promises[e.T].resolve({key:o.K,value:o.V})}},o=function(n,e){var t=n,r=function(n){return String.fromCharCode.apply(null,new Uint16Array(n))},o=function(n){for(var e=0,t=n.byteLength-1;t>=0;t--)e=256*e+n[t]
return parseInt(e)},i=new Uint8Array(t,0,8),s=o(i),c=parseInt(8+o(i))
e(r(new Uint8Array(t,8,s)),new Uint8Array(t,parseInt(c),t.byteLength-c),i)}
this.promises={},this.onconnected=function(){this.isConnected=!0},this.ondisconnected=function(){n.reconnect()},this.connectionAttempts=0,this.maxConnectionAttempts=5,this.controllers=[],this.listeners=[],this.queue=[],this.connection=void 0,this.isConnected=!1,this.isReconnecting=!1,this.reconnect=function(){this.connectionAttempts++,this.isReconnecting||(this.isReconnecting=!0,this.open())},this.url="",this.open=function(i,s,c){arguments.length>0&&(c?this.url=i:this.url=i+t(angular.extend({},e,s))),this.connection=new window.WebSocket(this.url,"XSocketsNET"),this.connection.binaryType="arraybuffer",this.connection.onclose=function(e){n.isReconnecting=!1,n.isConnected=!1,n.ondisconnected&&n.ondisconnected.apply(e)},this.connection.onopen=function(e){n.connectionAttempts=0,n.isReconnecting=!1,n.queue.forEach(function(e){n.send(e)}),n.queue.length=0,n.onconnected&&n.onconnected.apply(e)},this.connection.onmessage=function(n){n.data instanceof ArrayBuffer?o(n.data,function(n,e,t){var o=JSON.parse(n)
r(o,new Uint8Array(e),t)}):r(JSON.parse(n.data))}},this.sendBinary=function(n){this.connection.send(n)},this.send=function(n){1===this.connection.readyState?this.connection.send(n.toString()):this.queue.push(n)},this.setState=function(n,e){var t=this.controllers.find(function(e){return e.controller===n})
t&&(t.readyState=e)},this.controllerIsOpen=function(e){return this.controllers.find(function(n){return n.controller===e})?!0:(n.controllers.push({controller:e,readyState:0}),!1)},this.uuid=function(n,e){for(e=n="";n++<36;e+=51*n&52?(15^n?8^Math.random()*(20^n?16:4):4).toString(16):"-");return e},this.listener=function(n,e,t,r){this.instance=n,this.topic=e,this.controller=t,this.fn=r},this.$get=["$q","$rootScope",function(e,t){return function(r,o){var i={init:"1",ping:"7",pong:"8",controller:{onError:"4",onOpen:"2",onClose:"3"},storage:{set:"s1",get:"s2",clear:"s4",remove:"s3"},pubSub:{subscribe:"5",unsubscribe:"6"}},s=function(n){var e=function(n){this.fn=n}
return e.prototype.fire=function(e,t){n.$digest(this.fn.apply(this,[e,t]))},e}(t),c=n.uuid(),u=function(e,t,r){var o=n.listeners.filter(function(n){var o=n.topic===t&&n.controller===r&&n.instance===e
return o})
return o},a=function(e,t){var r=n.listeners.indexOf(u(c,e,t))
n.listeners.splice(r,1)},f=function(e,t,o,i){var a=new n.listener(e,t,o,new s(i)),f=u(c,t,r)
if(0===f.length)n.listeners.push(a)
else{var l=n.listeners.indexOf(f[0])
n.listeners[l]=a}},l=function(e,t){for(var r=0;r<n.listeners.length;r++)n.listeners[r].controller===t&&n.listeners[r].instance===e&&n.listeners.splice(r,1)},h=function(n){for(var e=[0,0,0,0,0,0,0,0],t=0;t<e.length;t++){var r=255&n
e[t]=r,n=(n-r)/256}return e},p=function(){var n=function(n,e,t){this.T=n?n.toLowerCase():void 0,this.D=e,this.C=t?t.toLowerCase():void 0,this.JSON={T:n,D:JSON.stringify(e),C:t}}
return n.prototype.toString=function(){return JSON.stringify(this.JSON)},n}(),d=function(){var n=function(n,e,t){this.buffer=this.createBuffer(new p(e,t,r).toString(),n)}
return n.prototype.stringToBuffer=function(n){var e,t=n.length,r=new Array(t)
for(e=0;t>e;e++)r[e]=255&n.charCodeAt(e)
return new Uint8Array(r).buffer},n.prototype.appendBuffer=function(n,e){var t=new Uint8Array(n.byteLength+e.byteLength)
return t.set(new Uint8Array(n),0),t.set(new Uint8Array(e),n.byteLength),t.buffer},n.prototype.createBuffer=function(n,e){var t=new Uint8Array(h(n.length)),r=this.appendBuffer(this.appendBuffer(t,this.stringToBuffer(n)),e)
return r},n}(),g=function(n){var t=e.defer(),r=new FileReader
return r.onload=function(){return function(n){t.resolve(n.target.result)}}(n),r.readAsArrayBuffer(n),t.promise},y=function(e){n.send(e)},v=function(n,e){var t,o="set_"+n.toLowerCase()
t=e instanceof Array?{value:e}:e instanceof Object?e:{value:e},y(new p(o,t,r))},w=function(n,e){var t="set_"+n.toLowerCase()
y(new p(t,e,r))},b=function(e){n.controllerIsOpen(e)||y(new p(i.init,{init:!0},e))},m=function(){y(new p(i.controller.onClose,{},r))},S={controllerName:r,uuid:c,onerror:null,onopen:null,onclose:null,on:function(n,e){f(c,n,r,e)},off:function(n){a(c,n,r)},invokeBinary:function(e){n.sendBinary(e)},createBlob:function(n,e){return new Blob([n],e)},createBinaryMessage:function(n,e,t){return new d(n,e,t).buffer},invoke:function(n,e){y(new p(n,e,r))},publish:function(n,e){y(new p(n,e,r))},kill:function(){n.connection.close()},getArrayBuffer:g,connectionAttempts:n.connectionAttempts,close:m,subscribe:function(n,e){f(c,n,r,e),y(new p(i.pubSub.subscribe,{T:n},r))},unsubscribe:function(n){a(c,n,r),y(new p(i.pubSub.unsubscribe,{T:n},r))},setEnum:w,storage:{set:function(n,e){n=n.toLowerCase()
var t=new p(i.storage.set,{K:n,V:"object"==typeof e?JSON.stringify(e):e},r)
return y(t),t},get:function(t){t=t.toLowerCase()
var o=e.defer(),s=i.storage.get+":"+t
n.promises[s]=o
var c=new p(i.storage.get,{K:t},r)
return y(c),o.promise},clear:function(){var n=new p(i.storage.clear,{},r)
y(n)},remove:function(n){n=n.toLowerCase()
var e=new p(i.storage.remove,{K:n},r)
y(e)}},setProperty:v,getListeners:function(){return n.listeners.filter(function(n){return n.controller===r&&n.instance===c})},removeListeners:l}
return f(c,i.controller.onOpen,r,function(n){var e={persistentId:n.PI,connectionId:n.CI}
localStorage.setItem("ci",JSON.stringify(e)),S.onopen&&S.onopen(e)}),f(c,i.controller.onClose,r,function(n){S.onclose&&S.onclose()}),f(c,i.controller.onError,r,function(n){S.onerror&&S.onerror(n,r)}),arguments[1]instanceof Array?o.forEach(function(n){v(n.name,n.value)}):2===arguments.length&&arguments[1].$on("$destroy",function(){S.close()}),3===arguments.length&&arguments[2].$on("$destroy",function(){S.close()}),b(r),S}}]}])}()
