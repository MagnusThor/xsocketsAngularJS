Array.prototype.find||(Array.prototype.find=function(n){var t;if(this===null)throw new TypeError("Array.prototype.find called on null or undefined");if(typeof n!="function")throw new TypeError("predicate must be a function");var i=Object(this),u=i.length>>>0,f=arguments[1],r;for(t=0;t<u;t++)if(r=i[t],n.call(f,r,t,i))return r;return undefined});"angular"in window&&function(){"use strict";angular.module("xsockets",[]);angular.module("xsockets").provider("xsocketsController",[function(){var n=this,i=JSON.parse(localStorage.getItem("ci")?localStorage.getItem("ci"):"{}"),r=function(n){var t="?";return delete n.C,Object.keys(n).forEach(function(i){t+=i+"="+encodeURIComponent(n[i])+"&"}),t=t.slice(0,t.length-1)},t=function(t,i){var u=n.listeners.filter(function(n){return n.controller===t.C&&n.topic===t.T}),r;u.forEach(function(n){n.fn.fire(JSON.parse(t.D),i,t.C)});n.promises.hasOwnProperty(t.T)&&(r=JSON.parse(t.D),n.promises[t.T].resolve({key:r.K,value:r.V}))},u=function(n,t){var i=n,e=function(n){return String.fromCharCode.apply(null,new Uint16Array(n))},u=function(n){for(var t=0,i=n.byteLength-1;i>=0;i--)t=t*256+n[i];return parseInt(t)},r=new Uint8Array(i,0,8),o=u(r),f=parseInt(8+u(r));t(e(new Uint8Array(i,8,o)),new Uint8Array(i,parseInt(f),i.byteLength-f),r)};this.promises={};this.onconnected=function(){this.isConnected=!0};this.ondisconnected=function(){n.reconnect()};this.connectionAttempts=0;this.controllers=[];this.listeners=[];this.queue=[];this.connection=undefined;this.isConnected=!1;this.isReconnecting=!1;this.reconnect=function(){(this.connectionAttempts++,this.isReconnecting)||(this.isReconnecting=!0,this.open())};this.url="";this.open=function(f,e,o){arguments.length>0&&(this.url=o?f:f+r(angular.extend({},i,e)));this.connection=new window.WebSocket(this.url);this.connection.binaryType="arraybuffer";this.connection.onclose=function(t){n.isReconnecting=!1;n.isConnected=!1;n.ondisconnected&&n.ondisconnected.apply(t)};this.connection.onopen=function(t){n.connectionAttempts=0;n.isReconnecting=!1;n.queue.forEach(function(t){n.send(t)});n.queue.length=0;n.onconnected&&n.onconnected.apply(t)};this.connection.onmessage=function(n){n.data instanceof ArrayBuffer?u(n.data,function(n,i,r){var u=JSON.parse(n);t(u,new Uint8Array(i),r)}):t(JSON.parse(n.data))}};this.sendBinary=function(n){this.connection.send(n)};this.send=function(n){this.connection.readyState===1?this.connection.send(n.toString()):this.queue.push(n)};this.setState=function(n,t){var i=this.controllers.find(function(t){return t.controller===n});i&&(i.readyState=t)};this.controllerIsOpen=function(t){return this.controllers.find(function(n){return n.controller===t})?!0:(n.controllers.push({controller:t,readyState:0}),!1)};this.uuid=function(n,t){for(t=n="";n++<36;t+=n*51&52?(n^15?8^Math.random()*(n^20?16:4):4).toString(16):"-");return t};this.listener=function(n,t,i,r){this.instance=n;this.topic=t;this.controller=i;this.fn=r};this.$get=["$q","$rootScope",function(t,i){return function(r,u){var e={init:"1",ping:"7",pong:"8",controller:{onError:"4",onOpen:"2",onClose:"3"},storage:{set:"s1",get:"s2",clear:"s4",remove:"s3"},pubSub:{subscribe:"5",unsubscribe:"6"}},y=function(n){var t=function(n){this.fn=n};return t.prototype.fire=function(t,i){n.$apply(this.fn.apply(this,[t,i]))},t}(i),s=n.uuid(),l=function(t,i,r){return n.listeners.filter(function(n){return n.topic===i&&n.controller===r&&n.instance===t})},a=function(t,i){var r=n.listeners.indexOf(l(s,t,i));n.listeners.splice(r,1)},c=function(t,i,u,f){var e=new n.listener(t,i,u,new y(f)),o=l(s,i,r),h;o.length===0?n.listeners.push(e):(h=n.listeners.indexOf(o[0]),n.listeners[h]=e)},p=function(t,i){for(var r=0;r<n.listeners.length;r++)n.listeners[r].controller===i&&n.listeners[r].instance===t&&n.listeners.splice(r,1)},w=function(n){for(var r,t=[0,0,0,0,0,0,0,0],i=0;i<t.length;i++)r=n&255,t[i]=r,n=(n-r)/256;return t},f=function(){var n=function(n,t,i){this.T=n?n.toLowerCase():undefined;this.D=t;this.C=i?i.toLowerCase():undefined;this.JSON={T:n,D:JSON.stringify(t),C:i}};return n.prototype.toString=function(){return JSON.stringify(this.JSON)},n}(),b=function(){var n=function(n,t,i){this.buffer=this.createBuffer(new f(t,i,r).toString(),n)};return n.prototype.stringToBuffer=function(n){for(var i=n.length,r=new Array(i),t=0;t<i;t++)r[t]=n.charCodeAt(t)&255;return new Uint8Array(r).buffer},n.prototype.appendBuffer=function(n,t){var i=new Uint8Array(n.byteLength+t.byteLength);return i.set(new Uint8Array(n),0),i.set(new Uint8Array(t),n.byteLength),i.buffer},n.prototype.createBuffer=function(n,t){var i=new Uint8Array(w(n.length));return this.appendBuffer(this.appendBuffer(i,this.stringToBuffer(n)),t)},n}(),k=function(n){var i=t.defer(),r=new FileReader;return r.onload=function(){return function(n){i.resolve(n.target.result)}}(n),r.readAsArrayBuffer(n),i.promise},o=function(t){n.send(t)},v=function(n,t){var i,u="set_"+n.toLowerCase();i=t instanceof Array?{value:t}:t instanceof Object?t:{value:t};o(new f(u,i,r))},d=function(n,t){var i="set_"+n.toLowerCase();o(new f(i,t,r))},g=function(t){n.controllerIsOpen(t)||o(new f(e.init,{init:!0},t))},nt=function(){o(new f(e.controller.onClose,{},r))},h={controllerName:r,uuid:s,onerror:null,onopen:null,onclose:null,on:function(n,t){c(s,n,r,t)},off:function(n){a(s,n,r)},invokeBinary:function(t){n.sendBinary(t)},createBlob:function(n,t){return new Blob([n],t)},createBinaryMessage:function(n,t,i){return new b(n,t,i).buffer},invoke:function(n,t){o(new f(n,t,r))},publish:function(n,t){o(new f(n,t,r))},kill:function(){n.connection.close()},getArrayBuffer:k,connectionAttempts:n.connectionAttempts,close:nt,subscribe:function(n,t){c(s,n,r,t);o(new f(e.pubSub.subscribe,{T:n},r))},unsubscribe:function(n){a(s,n,r);o(new f(e.pubSub.unsubscribe,{T:n},r))},setEnum:d,storage:{set:function(n,t){n=n.toLowerCase();var i=new f(e.storage.set,{K:n,V:typeof t=="object"?JSON.stringify(t):t},r);return o(i),i},get:function(i){var u,s,h;return i=i.toLowerCase(),u=t.defer(),s=e.storage.get+":"+i,n.promises[s]=u,h=new f(e.storage.get,{K:i},r),o(h),u.promise},clear:function(){var n=new f(e.storage.clear,{},r);o(n)},remove:function(n){n=n.toLowerCase();var t=new f(e.storage.remove,{K:n},r);o(t)}},setProperty:v,getListeners:function(){return n.listeners.filter(function(n){return n.controller===r&&n.instance===s})},removeListeners:p};return c(s,e.controller.onOpen,r,function(n){var t={persistentId:n.PI,connectionId:n.CI};if(localStorage.setItem("ci",JSON.stringify(t)),h.onopen)h.onopen(t)}),c(s,e.controller.onClose,r,function(){h.onclose&&h.onclose()}),c(s,e.controller.onError,r,function(n){if(instance.onerror)h.onerror(n,r)}),arguments[1]instanceof Array?u.forEach(function(n){v(n.name,n.value)}):arguments.length===2&&arguments[1].$on("$destroy",function(){h.close()}),arguments.length===3&&arguments[2].$on("$destroy",function(){h.close()}),g(r),h}}]}])}();